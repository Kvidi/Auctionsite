@using Auctionsite
@using Auctionsite.Models
@using Auctionsite.Models.Database
@using Auctionsite.Models.VM
@model AdCardVM

<div class="adCard px-2 mb-4">
    <div class="card h-100 border-0">
        @* Overlays for rejected and not approved *@
        @if (!Model.IsApproved && Model.IsRejected)
        {
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75" style="z-index:10;pointer-events:none;">
                <!-- Badge -->
                <span class="badge bg-danger text-dark opacity-50 fs-6 mb-2">Avvisad!</span>                               
            </div>
        }
        else if (!Model.IsApproved && !Model.IsRejected)
        {
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index:10;pointer-events:none;">
                <span class="badge bg-warning text-dark opacity-50 fs-6">Ej granskad än!</span>
            </div>
        }
        <div class="position-relative @(Model.IsApproved ? "" : "opacity-50")">
            <a asp-controller="Advertisement" asp-action="Details" asp-route-id="@Model.Id">
                <img src="@Model.HeadImageUrl" class="card-img-top rounded-0 adCardImg" width="250" height="250" alt="@Model.Title" loading="lazy" />
            </a>
            
            @if (User.Identity.IsAuthenticated)
            {
                <!-- If logged in: render favourite-toggle button -->
                <button type="button" class="btn fav-heart favourite-toggle @(Model.IsFavourite ? "favourited" : "") position-absolute top-0 end-0" data-ad-id="@Model.Id">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                    </svg>
                </button>
            }
            else
            {
                <!-- If not logged in: link to login-page with returnUrl -->
                var returnUrl = Context.Request.Path + Context.Request.QueryString; //Calculate return URL to redirect back after login
                <a type="button" class="btn fav-heart position-absolute top-0 end-0" data-ad-id="@Model.Id" asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@returnUrl" asp-route-toastMessage="Du måste vara inloggad för att spara annonser som favoriter.">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                    </svg>
                </a>
            }
            
        </div>
        <div class="card-body d-flex flex-column p-0">
            <h6 class="card-title adCardTitle mb-0 mt-3">
                <a asp-controller="Advertisement" asp-action="Details" asp-route-id="@Model.Id" class="text-dark text-decoration-none inter">
                    @Model.Title
                </a>
            </h6>

            <!--Auction end date and countdown timer, set by JS-->
            <p class="card-text small mb-0 countdown"
               data-end="@Model.AuctionEndDate?.ToString("o")"
               data-context="card"
               data-is-ended="@Model.IsEnded.ToString().ToLower()">

                <span class="countdown-date"></span>
                <span class="countdown-timer"></span>
            </p>

            <p class="card-text mt-0">
                @switch (Model.AdType)
                {
                    case AdType.Auction:
                        <span class="fw-bold me-1">@Model.CurrentHighestBid.ToString("C0")</span>
                        <small class="small">@Model.BidCount bud</small>
                        break;

                    case AdType.BuyNow:
                        <span class="fw-bold me-1">@Model.BuyNowPrice.Value.ToString("C0")</span>
                        <small class="small">Köp nu</small>
                        break;

                    case AdType.Both:
                        if (Model.BidCount > 0)
                        {
                            <span class="fw-bold me-1">@Model.CurrentHighestBid.ToString("C0")</span>
                            <small class="small">@Model.BidCount bud</small>
                        }
                        else
                        {
                            <span class="fw-bold me-1">@Model.StartingPrice.Value.ToString("C0")</span>
                            <small class="small">Eller köp nu @Model.BuyNowPrice.Value.ToString("C0")</small>
                        }
                        break;
                }
            </p>
        </div>
    </div>
</div>